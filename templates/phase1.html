<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <title>Defensio</title>
</head>

    <body class="bg-gray-200">
        <div id="flex-container-1" class="flex-container">
                <img src="/static/logo.png" alt="Votre Logo" class="w-12 h-12">
                <div id="timer">Timer : <span id="countdown"></span></div>
                <div id="numberDisplay" class="text-xl font-bold"></div>
        </div>
    </div>

    <div id="flex-container-2" class="flex-container">
        <div>
            <img src="/static/R.png" alt="Jauge R">
            <div id="JaugeR"></div>
        </div>
        <div>
            <img src="/static/C.png" alt="Jauge C">
            <div id="JaugeC"></div>
        </div>
        <div>
            <img src="/static/I.png" alt="Jauge I">
            <div id="JaugeI"></div>
        </div>
    </div>
    

    <div id="flex-container-3" class="flex-container">
        <div id="card-container" class="flex-container"></div>
        <div class="additional-containers">
            <div class="additional-container">Défense feu</div>
            <div class="additional-container">Défense terre</div>
            <div class="additional-container">Défense eau</div>
            <div class="additional-container">Défense air</div>
        </div>
    </div>

    <script>
        function getCookie(name) {
        var cookies = document.cookie.split(';');
        for (var i = 0; i < cookies.length; i++) {
            var cookie = cookies[i].trim();
            if (cookie.indexOf(name + "=") === 0) {
            return cookie.substring(name.length + 1);
            }
        }
        return "";
        };

        var storedNumber = getCookie("number");
        $("#numberDisplay").text("Équipe "+storedNumber);
    </script>
   
   <script>
    const timerDuration = 720;
    let countdown = timerDuration;
    let countdownInterval;

    function startTimer() {countdownInterval = setInterval(updateTimer, 1000);}

    function updateTimer() {
    const timerElement = document.getElementById('countdown');

    if (countdown > 0) {
        countdown--;
        timerElement.textContent = countdown;
    } else {
        clearInterval(countdownInterval);
        showConfirmationMessage();
    }
    }

    startTimer();

   </script>

   <script>

    function renderCard(card) {
        const cardsContainer = document.getElementById('card-container');
        cardsContainer.innerHTML = '';

        const cardContent = document.createElement('div');
        cardContent.id = 'card-content';
        cardContent.innerHTML = `
            <p>${card.nom}</p>
        `;
        cardsContainer.appendChild(cardContent);

        const columnsContainer = document.createElement('div');
        columnsContainer.id = 'columns-container';
        cardsContainer.appendChild(columnsContainer);

        const leftColumn = document.createElement('div');
        leftColumn.id = 'left-column';
        leftColumn.innerHTML = `
            <p>Si oui, la diplomatie : ${card.effet_oui_R}</p>    
            <p>Si oui, la popularité : ${card.effet_oui_C}</p>
            <p>Si oui, les ressources : ${card.effet_oui_I}</p>
            
        `;
        columnsContainer.appendChild(leftColumn);

        const rightColumn = document.createElement('div');
        rightColumn.id = 'right-column';
        rightColumn.innerHTML = `
            <p>Défense feu : + ${card.defense_feu}</p>
            <p>Défense terre : + ${card.defense_terre}</p>
            <p>Défense eau : + ${card.defense_eau}</p>
            <p>Défense air : + ${card.defense_air}</p>
            
        `;
        columnsContainer.appendChild(rightColumn);

        // Create a container for buttons
        const buttonContainer = document.createElement('div');
        buttonContainer.id = 'button-container';
        buttonContainer.innerHTML = `
            <button class="action-button" onclick="handleCardChoice('yes')">Oui</button>
            <button class="action-button" onclick="handleCardChoice('no')">Non</button>
        `;
        cardsContainer.appendChild(buttonContainer);

        // Update UI elements
        updateUI();
    }



    function handleCardChoice(choice) {
        // Get the current card
        const currentCard = cards[currentCardIndex];

        // Apply effects based on the user's choice
        if (choice === 'yes') {
            R += currentCard.effet_oui_R;
            I += currentCard.effet_oui_I;
            C += currentCard.effet_oui_C;
            D += currentCard.effet_oui_D;
            defenseAir = parseInt(defenseAir) + currentCard.air_defense;
            defenseEau = parseInt(defenseEau) + currentCard.water_defense;
            defenseFeu = parseInt(defenseFeu) + currentCard.fire_defense;
            defenseTerre = parseInt(defenseTerre) + currentCard.earth_defense;
            updateMetrics(
                        currentCard.effet_oui_R,
                        currentCard.effet_oui_C, 
                        currentCard.effet_oui_I,
                        currentCard.effet_oui_D, 
                        currentCard.bonus_oui_I,
                        currentCard.bonus_oui_R,
                        currentCard.bonus_oui_C,
                        currentCard.defense_feu,
                        currentCard.defense_terre,
                        currentCard.defense_eau,
                        currentCard.defense_air,
                        );
            
        } else if (choice === 'no') {
            R += currentCard.effet_non_R;
            C += currentCard.effet_non_C;
            I += currentCard.effet_non_I;
            D += currentCard.effet_non_D;
            updateMetrics(
                        currentCard.effet_non_R,
                        currentCard.effet_non_C, 
                        currentCard.effet_non_I,
                        currentCard.effet_non_D, 
                        currentCard.bonus_non_R,
                        currentCard.bonus_non_C,
                        currentCard.bonus_non_I,
                        0, 0, 0);
            
        }

        currentCardIndex++;

        if (currentCardIndex < cards.length) {
            renderCard(cards[currentCardIndex]);
        } else {
            showConfirmationMessage();
        }

        updateUI();

    }

    function showConfirmationMessage() {
    const confirmationContainer = document.createElement('div');
    confirmationContainer.id = 'confirmation-container';

    const confirmationMessage = document.createElement('p');
    confirmationMessage.textContent = "Vous avez tiré toutes les cartes ou le temps s'est écoulé. Il est temps pour vous donc de passer au débrief 1 !";
    confirmationContainer.appendChild(confirmationMessage);

    const confirmButton = document.createElement('button');
    confirmButton.textContent = 'Confirmer';
    confirmButton.addEventListener('click', function () {
        const url = `/debrief1`;
        window.location.href = url;
    });
    confirmationContainer.appendChild(confirmButton);   

    confirmationContainer.style.position = 'fixed';
    confirmationContainer.style.top = '0';
    confirmationContainer.style.left = '0';
    confirmationContainer.style.width = '100%';
    confirmationContainer.style.background = '#f8d7da';
    confirmationContainer.style.padding = '10px';
    confirmationContainer.style.textAlign = 'center';

    document.body.appendChild(confirmationContainer);
    }


    function updateMetrics(r, c, i, d, bonus_r, bonus_c, bonus_i, df, dt, de, da) {
    const formData = {
        
        jauge_r: r,
        jauge_c: c,
        jauge_i: i,
        jauge_d: d,
        bonus_r:bonus_r,
        bonus_c:bonus_c,
        bonus_i:bonus_i,
        defense_feu: df,
        defense_terre: dt,
        defense_eau: de,
        defense_air: da, 
        timer_total:timerDuration-countdown
    };

    console.log('Sending PUT request with data:', formData);

    fetch(`/put-jauge/${storedNumber}`, {
        method: 'PUT',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify(formData),
    })
    .then(response => {
        console.log('Réponse reçue :', response);
        return response.json();
    })
    .then(data => {
        console.log('JSON data:', data);
    })
    .catch(error => {
        console.error('Erreur avec updating metrics:', error);
    });
}


    function updateUI() {
        document.getElementById('JaugeR').innerText = `Diplomatie : ${R}`;
        document.getElementById('JaugeC').innerText = `Popularité : ${C}`;
        document.getElementById('JaugeI').innerText = `Ressources : ${I}`;
  
        const defenseFeu = parseInt(defenseFeu);
        const defenseTerre = parseInt(defenseTerre);
        const defenseEau = parseInt(defenseEau);
        const defenseAir = parseInt(defenseAir);
        
        document.getElementsByClassName('additional-container')[1].innerText = `Défense feu: ${parseInt(defenseFeu)}`;
        document.getElementsByClassName('additional-container')[2].innerText = `Défense terre: ${parseInt(defenseTerre)}`;
        document.getElementsByClassName('additional-container')[3].innerText = `Défense eau: ${parseInt(defenseEau)}`;
        document.getElementsByClassName('additional-container')[4].innerText = `Défense air: ${parseInt(defenseAir)}`;
        
    }
    
    let R = 50;
    let C = 50;
    let I = 50;
    let D = 0;
    let compteur_cartes = 0;
    let defenseFeu = 0;
    let defenseTerre = 0;
    let defenseEau = 0;
    let defenseAir = 0;
   
    let currentCardIndex = 0;
    let data_unshuffled;
    let cards;

    fetch('/get-jauge/'+storedNumber)
        .then(response => response.json())
        .then(apidata => {
            R=apidata.jauge_r;
            C=apidata.jauge_c;
            I=apidata.jauge_i;
            D=apidata.jauge_d;
            defenseFeu=apidata.defense_feu;
            defenseTerre=apidata.defense_terre;
            defenseEau=apidata.defense_eau;
            defenseAir=apidata.defense_air;
            compteur_cartes=api.compteur_cartes;

            updateUI();
        });

    fetch('/api/cards')
        .then(response => response.json())
        .then(apidata => {
            data_unshuffled = apidata;
            cards = data_unshuffled.cards
                .map(value => ({ value, sort: Math.random() }))
                .sort((a, b) => a.sort - b.sort)
                .map(({ value }) => value)
            renderCard(cards[currentCardIndex]);
        });
</script>


</body>
</html>

